<?php

namespace App\Services;

use GuzzleHttp\Client;
use GuzzleHttp\Exception\RequestException;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;

class OllamaService
{
    private $client;
    private $baseUrl;
    private $primaryModel;
    private $secondaryModel;
    private $embeddingModel;

    public function __construct()
    {
        $this->baseUrl = config('services.ollama.url', 'http://localhost:11434');
        $this->primaryModel = config('services.ollama.primary_model', 'mistral:7b');
        $this->secondaryModel = config('services.ollama.secondary_model', 'llama3.2:3b');
        $this->embeddingModel = config('services.ollama.embedding_model', 'nomic-embed-text');

        $this->client = new Client([
            'base_uri' => $this->baseUrl,
            'timeout' => 60,
            'connect_timeout' => 10,
        ]);
    }

    /**
     * Verificar si Ollama est√° funcionando
     */
    public function isHealthy(): bool
    {
        try {
            $response = $this->client->get('/api/version');
            return $response->getStatusCode() === 200;
        } catch (RequestException $e) {
            Log::error('Ollama health check failed: ' . $e->getMessage());
            return false;
        }
    }

    /**
     * Obtener lista de modelos disponibles
     */
    public function getAvailableModels(): array
    {
        try {
            $response = $this->client->get('/api/tags');
            $data = json_decode($response->getBody(), true);

            return collect($data['models'] ?? [])
                ->map(function ($model) {
                    return [
                        'name' => $model['name'],
                        'size' => $model['size'] ?? 0,
                        'modified_at' => $model['modified_at'] ?? null
                    ];
                })
                ->toArray();
        } catch (RequestException $e) {
            Log::error('Failed to get Ollama models: ' . $e->getMessage());
            return [];
        }
    }

    /**
     * Generar respuesta usando el modelo especificado
     */
    public function generateResponse(string $prompt, array $options = []): array
    {
        $model = $options['model'] ?? $this->primaryModel;
        $temperature = $options['temperature'] ?? 0.7;
        $maxTokens = $options['max_tokens'] ?? 1000;

        try {
            $startTime = microtime(true);

            $response = $this->client->post('/api/generate', [
                'json' => [
                    'model' => $model,
                    'prompt' => $prompt,
                    'stream' => false,
                    'options' => [
                        'temperature' => $temperature,
                        'num_predict' => $maxTokens,
                        'top_p' => 0.9,
                        'top_k' => 40,
                    ]
                ]
            ]);

            $data = json_decode($response->getBody(), true);
            $responseTime = round((microtime(true) - $startTime) * 1000);

            return [
                'success' => true,
                'response' => $data['response'] ?? '',
                'model' => $model,
                'response_time' => $responseTime,
                'tokens_evaluated' => $data['eval_count'] ?? 0,
                'tokens_generated' => $data['eval_count'] ?? 0,
            ];

        } catch (RequestException $e) {
            Log::error('Ollama generation failed: ' . $e->getMessage());

            return [
                'success' => false,
                'error' => $e->getMessage(),
                'model' => $model,
                'response_time' => 0,
            ];
        }
    }

    /**
     * Generar embeddings para b√∫squeda sem√°ntica
     */
    public function generateEmbedding(string $text): array
    {
        $cacheKey = 'embedding_' . md5($text);

        // Verificar cache primero
        if (Cache::has($cacheKey)) {
            return Cache::get($cacheKey);
        }

        try {
            $response = $this->client->post('/api/embeddings', [
                'json' => [
                    'model' => $this->embeddingModel,
                    'prompt' => $text
                ]
            ]);

            $data = json_decode($response->getBody(), true);
            $embedding = $data['embedding'] ?? [];

            // Cachear por 1 hora
            Cache::put($cacheKey, $embedding, 3600);

            return $embedding;

        } catch (RequestException $e) {
            Log::error('Ollama embedding failed: ' . $e->getMessage());
            return [];
        }
    }

    /**
     * Generar respuesta contextualizada para Ociel
     */
    public function generateOcielResponse(string $userMessage, array $context = [], string $userType = 'public', string $department = null): array
    {
        $systemPrompt = $this->buildOcielSystemPrompt($context, $userType, $department);
        $fullPrompt = $systemPrompt . "\n\nUsuario: " . $userMessage . "\n\nOciel:";

        // Usar modelo secundario para consultas simples, primario para complejas
        $useSecondaryModel = $this->isSimpleQuery($userMessage);
        $model = $useSecondaryModel ? $this->secondaryModel : $this->primaryModel;

        $response = $this->generateResponse($fullPrompt, [
            'model' => $model,
            'temperature' => 0.7,
            'max_tokens' => 1200 // Incrementado para respuestas m√°s detalladas
        ]);

        // Aplicar mejoras de formato a la respuesta
        if ($response['success'] && !empty($response['response'])) {
            $response['response'] = $this->enhanceResponseFormat($response['response']);

            // Agregar informaci√≥n de contacto espec√≠fica si no est√° presente
            $response['response'] = $this->ensureContactInfo($response['response'], $department, $userType);
        }

        return $response;
    }

    /**
     * Asegurar que la respuesta incluya informaci√≥n de contacto relevante
     */
    private function ensureContactInfo(string $response, ?string $department, string $userType): string
    {
        // Si ya contiene informaci√≥n de contacto, no agregar m√°s
        if (preg_match('/üìû|tel√©fono|tel:|email|contacto/i', $response)) {
            return $response;
        }

        // Agregar informaci√≥n de contacto seg√∫n el departamento
        $contactInfo = $this->getContactInfoByDepartment($department);

        if ($contactInfo) {
            $response .= "\n\nüìû **M√°s informaci√≥n:**\n";
            $response .= $contactInfo;
        }

        return $response;
    }

    /**
     * Obtener informaci√≥n de contacto espec√≠fica por departamento
     */
    private function getContactInfoByDepartment(?string $department): string
    {
        $contacts = [
            'DGAE' => "üìû DGAE: 311-211-8800 ext. 8530\nüìß dgae@uan.edu.mx",
            'UAM' => "üìû Medicina: 311-211-8800 ext. 8630\nüìß direccion.medicina@uan.edu.mx",
            'UACBI' => "üìû Ingenier√≠as: 311-211-8800 ext. 8600\nüìß direccion@uan.edu.mx",
            'UACS' => "üìû Ciencias Sociales: 311-211-8800 ext. 8610\nüìß direccion.cs@uan.edu.mx",
            'DGS' => "üìû Sistemas: 311-211-8800 ext. 8540\nüìß dgs@uan.edu.mx"
        ];

        return $contacts[$department] ?? "üìû Informaci√≥n general: 311-211-8800\nüåê www.uan.edu.mx";
    }

    /**
     * Determinar si una consulta es compleja y requiere respuesta detallada
     */
    private function isComplexQuery(string $message): bool
    {
        $complexIndicators = [
            'plan de estudios', 'requisitos', 'proceso de', 'c√≥mo puedo',
            'informaci√≥n detallada', 'explicame', 'diferencia entre',
            'comparar', 'ventajas', 'desventajas', 'modalidades'
        ];

        $messageLower = strtolower($message);

        foreach ($complexIndicators as $indicator) {
            if (str_contains($messageLower, $indicator)) {
                return true;
            }
        }

        // Si el mensaje es largo (m√°s de 15 palabras), probablemente es complejo
        return str_word_count($message) > 15;
    }

    /**
     * Construir prompt del sistema para Ociel
     */
    private function buildOcielSystemPrompt(array $context, string $userType, ?string $department): string
    {
        $prompt = "Eres Ociel, el asistente virtual oficial de la Universidad Aut√≥noma de Nayarit (UAN). ";
        $prompt .= "Tu misi√≥n es brindar informaci√≥n precisa, actualizada y √∫til sobre la universidad.\n\n";

        $prompt .= "INFORMACI√ìN DEL USUARIO:\n";
        $prompt .= "- Tipo: " . ucfirst($userType) . "\n";

        if ($department) {
            $prompt .= "- Departamento de inter√©s: " . $department . "\n";
        }

        if (!empty($context)) {
            $prompt .= "\nINFORMACI√ìN RELEVANTE DE LA UAN:\n";
            foreach ($context as $item) {
                $prompt .= "‚Ä¢ " . $item . "\n";
            }
        }

        $prompt .= "\nFORMATO DE RESPUESTA REQUERIDO:\n";
        $prompt .= "- Usa una estructura clara con t√≠tulos y subt√≠tulos\n";
        $prompt .= "- Incluye emojis relevantes al inicio de cada secci√≥n (üéì üìã üìû etc.)\n";
        $prompt .= "- Organiza la informaci√≥n en listas cuando sea apropiado\n";
        $prompt .= "- Resalta datos importantes como duraci√≥n, costos, fechas\n";
        $prompt .= "- Siempre incluye informaci√≥n de contacto espec√≠fica al final\n";
        $prompt .= "- Usa un tono amigable pero profesional\n\n";

        $prompt .= "INSTRUCCIONES ESPEC√çFICAS:\n";
        $prompt .= "- Responde en espa√±ol de manera estructurada y organizada\n";
        $prompt .= "- S√© conciso pero completo en la informaci√≥n\n";
        $prompt .= "- Si no tienes informaci√≥n espec√≠fica, indica c√≥mo pueden obtener ayuda\n";
        $prompt .= "- Proporciona datos de contacto relevantes\n";
        $prompt .= "- Mant√©n un tono conversacional pero acad√©mico\n";
        $prompt .= "- Si la consulta requiere atenci√≥n especializada, dirige al departamento correcto\n";
        $prompt .= "- Estructura las respuestas con subt√≠tulos claros\n\n";

        // Agregar plantillas de respuesta seg√∫n el tipo de consulta
        $prompt .= "PLANTILLAS DE RESPUESTA:\n\n";

        $prompt .= "Para CARRERAS/PROGRAMAS ACAD√âMICOS:\n";
        $prompt .= "üéì [Nombre de la Carrera] - UAN\n";
        $prompt .= "üìã Informaci√≥n general:\n";
        $prompt .= "‚Ä¢ Duraci√≥n: [X a√±os/semestres]\n";
        $prompt .= "‚Ä¢ Modalidad: [Presencial/Virtual/Mixta]\n";
        $prompt .= "‚Ä¢ Ubicaci√≥n: [Campus/Sede]\n";
        $prompt .= "üìö Plan de estudios: [descripci√≥n breve]\n";
        $prompt .= "üéØ Campo laboral: [√°reas de trabajo]\n";
        $prompt .= "üìû Contacto: [informaci√≥n espec√≠fica]\n\n";

        $prompt .= "Para TR√ÅMITES/SERVICIOS:\n";
        $prompt .= "üìù [Nombre del Tr√°mite]\n";
        $prompt .= "üìã Requisitos:\n";
        $prompt .= "‚Ä¢ [Listar requisitos]\n";
        $prompt .= "‚è∞ Proceso:\n";
        $prompt .= "‚Ä¢ [Pasos a seguir]\n";
        $prompt .= "üìç Ubicaci√≥n: [d√≥nde realizar el tr√°mite]\n";
        $prompt .= "üìû M√°s informaci√≥n: [contacto espec√≠fico]\n\n";

        $prompt .= "Para INFORMACI√ìN GENERAL:\n";
        $prompt .= "üèõÔ∏è Universidad Aut√≥noma de Nayarit\n";
        $prompt .= "[Informaci√≥n solicitada organizadamente]\n";
        $prompt .= "üìû Contacto general: 311-211-8800\n\n";

        return $prompt;
    }

    // M√©todo adicional para post-procesar respuestas y mejorar formato
    private function enhanceResponseFormat(string $response): string
    {
        // Mejorar la estructura de las respuestas generadas
        $enhanced = $response;

        // Asegurar que hay emojis al inicio de t√≠tulos principales
        $enhanced = preg_replace('/^([A-Z√Å√â√ç√ì√ö][^:\n]*):?$/m', 'üéØ $1:', $enhanced);

        // Mejorar formato de listas
        $enhanced = preg_replace('/^[\*\-]\s+(.+)$/m', '‚Ä¢ $1', $enhanced);

        // Resaltar informaci√≥n importante (n√∫meros, fechas, etc.)
        $enhanced = preg_replace('/(\d+\s*(a√±os?|meses?|semestres?))/i', '**$1**', $enhanced);
        $enhanced = preg_replace('/(\$[\d,]+)/i', '**$1**', $enhanced);

        // Mejorar informaci√≥n de contacto
        $enhanced = preg_replace('/(Tel(?:√©fono)?:?\s*)([\d\-\s\(\)ext\.]+)/i', 'üìû $2', $enhanced);
        $enhanced = preg_replace('/(Email:?\s*)([\w\.\-]+@[\w\.\-]+)/i', 'üìß $2', $enhanced);

        return $enhanced;
    }

    /**
     * Determinar si una consulta es simple
     */
    private function isSimpleQuery(string $message): bool
    {
        $simplePatterns = [
            '/^(hola|hi|hello)/i',
            '/^(gracias|thanks)/i',
            '/^(adi√≥s|bye)/i',
            '/^(s√≠|no|ok)/i',
            '/\?$/',  // Preguntas simples
        ];

        $wordCount = str_word_count($message);

        // Si tiene menos de 10 palabras o coincide con patrones simples
        if ($wordCount < 10) {
            return true;
        }

        foreach ($simplePatterns as $pattern) {
            if (preg_match($pattern, $message)) {
                return true;
            }
        }

        return false;
    }

    /**
     * Verificar que los modelos est√©n disponibles
     */
    public function checkRequiredModels(): array
    {
        $availableModels = collect($this->getAvailableModels())->pluck('name')->toArray();

        $requiredModels = [
            'primary' => $this->primaryModel,
            'secondary' => $this->secondaryModel,
            'embedding' => $this->embeddingModel
        ];

        $status = [];

        foreach ($requiredModels as $type => $model) {
            $status[$type] = [
                'model' => $model,
                'available' => in_array($model, $availableModels),
                'type' => $type
            ];
        }

        return $status;
    }

    /**
     * Obtener estad√≠sticas de uso
     */
    public function getUsageStats(): array
    {
        // Esto se podr√≠a expandir para incluir m√©tricas reales
        return [
            'total_requests' => Cache::get('ollama_requests', 0),
            'average_response_time' => Cache::get('ollama_avg_time', 0),
            'models_used' => Cache::get('ollama_models_used', []),
            'health_status' => $this->isHealthy()
        ];
    }
}
